"use strict";function List(e,t,n){e.query({query:encodeURIComponent(JSON.stringify(t))},function(e){e&&0===e.code&&n(e.value)})}function PatientsList(e,t){var n=new Date;n.setHours(23,59,59,99);var i=new Date;i.setHours(0,0,0,1);var r={$and:[{Date:{$lte:n}},{Date:{$gt:i}}]};e.query({query:encodeURIComponent(JSON.stringify(r))},function(e,n){null!=e&&0===e.code&&t(e.value,n)})}var controllers=angular.module("PatientsControllers",["ngMaterial","ngResource","ngMessages","ngMdIcons","ngAnimate"]),Browser=function(){function e(){this.name=window.navigator.userAgent.toLowerCase(),this.isIE=this.name.indexOf("msie")>=0||this.name.indexOf("trident")>=0,this.isiPhone=this.name.indexOf("iphone")>=0,this.isiPod=this.name.indexOf("ipod")>=0,this.isiPad=this.name.indexOf("ipad")>=0,this.isiOS=this.isiPhone||this.isiPod||this.isiPad,this.isAndroid=this.name.indexOf("android")>=0,this.isPhone=this.isiOS||this.isAndroid,this.isTablet=this.isiPad||this.isAndroid&&this.name.indexOf("mobile")<0,this.isIE&&(this.verArray=/(msie|rv:?)\s?([0-9]{1,})([\.0-9]{1,})/.exec(this.name),this.verArray&&(this.ver=parseInt(this.verArray[2],10))),this.isiOS&&(this.verArray=/(os)\s([0-9]{1,})([\_0-9]{1,})/.exec(this.name),this.verArray&&(this.ver=parseInt(this.verArray[2],10))),this.isAndroid&&(this.verArray=/(android)\s([0-9]{1,})([\.0-9]{1,})/.exec(this.name),this.verArray&&(this.ver=parseInt(this.verArray[2],10)))}return e}();controllers.value("Global",{socket:null}),controllers.value("Views",{Data:[]}),controllers.value("CurrentPatient",{Information:{name:"",insurance:""},Status:"",Category:"",Input:{},Sequential:0}),controllers.factory("PatientQuery",["$resource",function(e){return e("/patient/query/:query",{query:"@query"},{query:{method:"GET"}})}]),controllers.factory("Patient",["$resource",function(e){return e("/patient/:id",{},{update:{method:"PUT"}})}]),controllers.factory("ViewQuery",["$resource",function(e){return e("/view/query/:query",{query:"@query"},{query:{method:"GET"}})}]),controllers.controller("BrowseSController",["$scope","$stateParams","$location","Patient","PatientQuery","CurrentPatient","Global","ViewQuery","Views",function(e,t,n,i,r,o,a,s,u){List(s,{},function(t){PatientsList(r,function(n){e.patients=n,u.Data=t})}),e.next=function(t){var r=new i;r.$get({id:t},function(i){null!=i&&0===i.code&&(o.id=t,o.Category=i.value.Category,o.Information=i.value.Information,o.Sequential=i.value.Sequential,e.Information=o.Information,e.Input=o.Input,e.Sequential=o.Sequential,n.path("/browse/0"))})},null===a.socket&&(a.socket=io.connect()),a.socket.on("client",function(t){"1"===t.value&&PatientsList(r,function(t){e.patients=t})})}]),controllers.controller("BrowseController",["$scope","$stateParams","$location","CurrentPatient","Views",function(e,t,n,i,r){e.Input=i.Input;var o=t.page,a="rgba(200, 20, 30, 0.4)",s=_.filter(r.Data,function(e){return e.Name===i.Category});if(e.contents=s[0].Pages[o],e.contents.picture.length>0){var u=new fabric.Canvas("schema");_.map(e.contents.picture,function(t,n){u.setBackgroundImage("/file/"+t.path,u.renderAll.bind(u),{backgroundImageOpacity:1,backgroundImageStretch:!1}),null===e.Input[t.name]&&fabric.Image.fromURL("/file/"+t.path,function(e){});var i=JSON.stringify(e.Input[t.name]);u.loadFromJSON(i,u.renderAll.bind(u),function(e,t){})}),u.on({"touch:gesture":function(e){},"touch:drag":function(e){},"touch:orientation":function(e){},"touch:shake":function(e){},"touch:longpress":function(e){},"mouse:up":function(e){var t=20,n=new Browser;if(n.isTablet)var i=new fabric.Circle({radius:t,fill:a,left:e.e.changedTouches[0].clientX-t/2-u._offset.left,top:e.e.changedTouches[0].clientY-t/2-u._offset.top});else var i=new fabric.Circle({radius:t,fill:a,left:e.e.layerX-t/2,top:e.e.layerY-t/2});u.add(i)}})}e.clearPicture=function(){u.clear().renderAll()},e.setColor=function(e){a=e},e.next=function(t){_.map(e.contents.items,function(t,n){if("check"===t.type){var i=t.name.split("-"),r=i[1];t.model||(r=!1),e.Input[t.name]={name:i[0],value:r,type:t.type}}else e.Input[t.name]={name:t.name,value:t.model,type:t.type}}),_.map(e.contents.picture,function(t,n){e.Input[t.name]={name:t.name,value:u.toJSON(),type:t.type}}),i.Input=e.Input,n.path(t)}}]),controllers.controller("ConfirmController",["$scope","$stateParams","CurrentPatient","Patient","Global",function(e,t,n,i,r){e.Input=n.Input}]),controllers.controller("WriteController",["$scope","$stateParams","$location","CurrentPatient","Patient","Global",function(e,t,n,i,r,o){e.Input=i.Input,e.send=!0;var a=new r;a.Input=i.Input,a.Sequential=i.Sequential,a.Status="Accepted",a.$update({id:i.id},function(t,r){i.Input={},n.path("/browseS"),o.socket.emit("server",{value:"1"}),e.send=!1})}]);